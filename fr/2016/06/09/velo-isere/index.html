

<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="We make maps in the Alps. On fait de la cartographie dans les Alpes!">
    <meta name="author" content="Maptime-Alpes Contributors">
    <link rel="apple-touch-icon-precomposed" sizes="57x57" href="/assets/img/apple-touch-icon-57x57.png" />
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/assets/img/apple-touch-icon-114x114.png" />
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/assets/img/apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/img/apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon-precomposed" sizes="120x120" href="/assets/img/apple-touch-icon-120x120.png" />
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="/assets/img/apple-touch-icon-152x152.png" />
    <link rel="icon" type="image/png" href="/assets/img/favicon-32x32.png" />
    <link rel="icon" type="image/png" href="/assets/img/favicon-16x16.png" />
    <meta name="application-name" content="Maptime-Alpes"/>
    <meta name="msapplication-TileColor" content="#FFFFFF" />
    <meta name="msapplication-TileImage" content="/assets/img/mstile-144x144.png" />

    <title>MaptimeAlpes - Vélo Isère</title>

    <!-- Custom styles for this template -->
    <link href="/assets/css/style.css" rel="stylesheet">
    <link href="/assets/css/fontcustom/fontcustom.css" rel="stylesheet">
    
    <link href="/assets/css/prism.css" rel="stylesheet">
    <link rel="stylesheet" href="https://rawgit.com/lmenezes/json-tree/master/dist/css/jsontree.css" />
    <script src="https://rawgit.com/lmenezes/json-tree/master/dist/js/jsontree.min.js"></script>
    

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <script src="/assets/js/modernizr.js"></script>
    <script src="/assets/js/prism.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script src="/assets/js/bootstrap.min.js"></script>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-55615382-1', 'auto');
  ga('send', 'pageview');

	var _gaq = _gaq || [];
	_gaq.push(['_setAccount', 'UA-55615382-1']);

	// set custom variables
	_gaq.push(['_setCustomVar',
      1,
      'Locale',
      'fr',
      3                    // Sets the scope to page-level.  Optional parameter.
   ]);

	// track page view
	_gaq.push(['_trackPageview']);

	(function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	})();
</script>


</head>

    <body>
        

<!-- Fixed navbar -->
<div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">

      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">
        <svg id="mt_pin" viewBox="0 0 29 41" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <path d="M12.7656702,16.506016 C13.1349844,16.6854737 13.5496704,16.7861333 13.9878667,16.7861333 C15.534264,16.7861333 16.7878667,15.5325306 16.7878667,13.9861333 C16.7878667,12.7669958 16.0087129,11.7298393 14.9212,11.3454587 L14.9212,5.58613333 L13.9878667,4.6528 L13.0545333,5.58613333 L13.0545333,11.3454587 C11.9670205,11.7298393 11.1878667,12.7669958 11.1878667,13.9861333 C11.1878667,14.4124673 11.2831501,14.8165465 11.4535834,15.1782375 L8.29929023,18.3325306 L8.29929023,19.6524633 L9.61922289,19.6524633 L12.7656702,16.506016 Z M14.0160043,0.016 C17.8989916,0.016 21.2027378,1.37751175 23.9272427,4.10053526 C26.6517476,6.82355876 28.014,10.1255085 28.014,14.0063846 C28.014,15.9468226 27.5282925,18.1690449 26.5568776,20.6730513 C25.5854627,23.1770577 24.4109458,25.5248141 23.0333271,27.7163205 C21.6557084,29.9078269 20.293456,31.9577735 18.9465698,33.8661603 C17.5996836,35.774547 16.4565674,37.2923088 15.5172212,38.4194455 L14.014,40.016 C13.6385288,39.5779658 13.137455,38.9990395 12.5107788,38.2792212 C11.8841026,37.5594028 10.7563527,36.119766 9.12752899,33.9603109 C7.49870532,31.8008558 6.07365163,29.7035 4.85236793,27.6682436 C3.63108423,25.6329872 2.51936865,23.33264 1.51722119,20.7672019 C0.515073729,18.2017639 0.014,15.9481581 0.014,14.0063846 C0.014,10.1255085 1.37625245,6.82355876 4.10075734,4.10053526 C6.82526223,1.37751175 10.1290084,0.016 14.0119957,0.016 L14.0160043,0.016 Z M13.9878667,24.2528 C19.6579901,24.2528 24.2545333,19.6562568 24.2545333,13.9861333 C24.2545333,8.3160099 19.6579901,3.71946667 13.9878667,3.71946667 C8.31774324,3.71946667 3.7212,8.3160099 3.7212,13.9861333 C3.7212,19.6562568 8.31774324,24.2528 13.9878667,24.2528 Z" id="Shape" fill="#231F20"></path>
    </g>
</svg>

        <span>Maptime Alpes!</span>
      </a>
    </div>
    <div class="navbar-collapse collapse navbar-right">
      <ul class="nav navbar-nav">
        
        <li>
          <a href="/">Accueil</a>
        </li>
        
        <li>
          <a href="/fr/blog/">Blog</a>
        </li>
        
        <li>
          <a href="/fr/ateliers/">Ateliers</a>
        </li>
        
        <li>
          <a href="/fr/apropos/">À propos</a>
        </li>
        
        <li>
          <a href="http://www.maptime.io">Maptime.io</a>
        </li>
        
        <li><div class="locale-links">
          
            
              <a href="/"><img class="flag" src="/assets/img/fr.png"/>
            
              </a>
          
            
              <a href="/en"><img class="flag" src="/assets/img/us.png"/>
            
              </a>
          
        </div></li>
      </ul>
    </div><!--/.nav-collapse -->
  </div>
</div>

        

<div id="miniheaderwrap" class='tut'>
    <div class="mini-map-banner">
    	<div class="container">
        	<div class="pull-left mini-text-block">
            	<h3 id="page-title" class="pull-left">Vélo Isère</h3>
            </div>
        </div>
    </div>
</div>

<div class="tutorial container" id="tutorial">
<p class="tut_auth_date"><csmall>

09 June, 2016
 par <a href="http://www.github.com/abenrob" target="_blank">abenrob</a>

</csmall></p>
<div class="hline"></div>
<p>Dans ce tutoriel nous allons explorer les caractéristiques d’APIs de calcul d’itinéraire et construire une application simple pour trouver un itinéraire vélo entre deux points. Nous allons utiliser la géolocalisation par HTML5 pour indiquer notre localisation. La Base Adresse Nationale <a href="https://adresse.data.gouv.fr/api/">BAN</a> nous permettra de trouver notre destination et les sites  <a href="http://www.itinisere.fr/fr/api-open-services/169/OpenData/openservices">itinIsère</a> et <a href="http://www.metromobilite.fr/pages/opendata/OpenDataApi.html">Métromobilité</a> nous aiderons à trouver les itinéraires.
<!--more--></p>

<h2 id="avant-de-commencer">Avant de commencer</h2>
<p>Pour bien suivre ce tutoriel vous aurez besoin d’un éditeur de texte (comme Notepad++ ou Atom). Pas de problème si vous souhaitez utiliser le vôtre mais si vous n’en n’avez pas d’installé, vous pouvez télécharger  <a href="https://atom.io/">Atom Editor</a>.
Vous aurez également besoin de lancer un serveur web en local sur votre machine pour accéder à des ressources distantes comme des APIs. La manière la plus simple de le faire si vous avez Python installé est de naviguer avec la console à la racine du projet et de taper la commande  <code>python -m SimpleHTTPServer</code>. Cela activera une page web à l’adresse suivante :  <a href="http://localhost:8000">http://localhost:8000</a> .</p>

<h1 id="dmarrage">Démarrage</h1>

<h2 id="sites-web">Sites web</h2>
<p>Au cours de cet atelier, nous allons construire une application web simple. Pour commencer, nous devons donc évoquer certains éléments d’un site web.</p>

<p>Un site web simple est composé de fichiers HTML, CSS et Javascript. Le HTML (Hyper Text Markup Language) fournit la structure de la page - il indique la position de chaque élément et fait référence aux autres composants de la page. Les CSS (Cascading Style Sheets) forment les règles de style qui sont mises en place pour décrire comment les éléments HTML doivent apparaître. Javascript est un langage de programmation utilisé par les sites web pour <em>agir</em> - recevoir des données, gérer les interactions, manipuler les données, etc. <a href="https://jquery.com/">jQuery</a>  est une bibliothèque Javascript qui facilite grandement la manipulation du document, la gestion des événements et l’accès aux données. <a href="http://getbootstrap.com/">Bootstrap</a> est un “framework”, fait de CSS et de Javascript, qui permet de façonner un site web plus facilement, sans écrire les fichiers de style par soi-même. Ces ressources sont très utiles pour prototyper un site, ou donner rapidement un aspect soigné à un tutoriel ;)</p>

<h2 id="une-carte-web-simple">Une carte web simple</h2>
<p>Nous allons utiliser <a href="https://www.mapbox.com/mapbox.js/api/v2.4.0/">MapboxJS</a> (qui est une extension de <a href="http://leafletjs.com/">LeafletJS</a>) pour mettre en place la carte dans l’application en très peu de lignes de code.</p>

<p>A la racine de notre projet, nous allons créer un fichier nommé ‘index.html’, un second nommé ‘style.css’ et un troisième nommé ‘script.js’.</p>

<p>Dans index.html nous plaçons ce contenu :</p>

<pre><code class="language-markup">&lt;!DOCTYPE html&gt;
&lt;html&gt;

&lt;head&gt;
  &lt;meta charset=utf-8 /&gt;
  &lt;title&gt;VéloIsère&lt;/title&gt;
  &lt;meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' /&gt;
  &lt;link href='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.css' rel='stylesheet' /&gt;
  &lt;link href='style.css' rel='stylesheet' /&gt;
  &lt;script src='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.js'&gt;&lt;/script&gt;
&lt;/head&gt;

&lt;body&gt;
  &lt;div id="map"&gt;&lt;/div&gt;
  &lt;script src="script.js"&gt;&lt;/script&gt;
&lt;/body&gt;

&lt;/html&gt;
</code></pre>

<p>Dans la balise &lt;head&gt;, vous noterez les références à notre style.css, ainsi qu’à mapbox.js. La référence à ‘script.js’ est située sous le conteneur de la carte (&lt;div id="map"&gt;&lt;/div&gt;) pour que la bibliothèque de cartographie ne soit pas appelée avant que le conteneur de la carte soit affiché.</p>

<p>Placez ce contenu dans style.css :</p>

<pre><code class="language-css">body {
  margin: 0;
  padding: 0;
}
#map {
  position: absolute;
  top: 0;
  bottom: 0;
  width: 100%;
}
</code></pre>

<p>Nous précisons ici que la page et le conteneur de la carte doivent prendre toute la largeur et toute la hauteur.</p>

<p>Et placez ce contenu dans script.js :</p>

<pre><code class="language-javascript">// define mapbox token for map creation
L.mapbox.accessToken = 'pk.eyJ1IjoiYWJlbnJvYiIsImEiOiJEYmh3WWNJIn0.fus8CLBKPBHDvSxiayhJyg';

// set up map
var map = L.mapbox.map('map', 'mapbox.streets')
    .setView([45.186502, 5.736339], 13);
</code></pre>

<p>Ici nous fournissons notre jeton (mapbox est un service soumis à abonnement, avec un premier niveau gratuit) et nous appelons la bibliothèque mapbox pour créer une carte avec le style ‘streets’ centrée sur Grenoble. Cette carte sera assignée à l’élément HTML dont l’identifiant (id) est ‘map’.</p>

<p>Démarrez votre serveur web et admirez la page que nous avons créé :</p>

<!-- codepen embed -->
<p data-height="500" data-theme-id="0" data-slug-hash="YWXdPN" data-default-tab="result" data-user="abenrob" data-embed-version="2" data-preview="true" class="codepen"></p>
<script async="" src="//assets.codepen.io/assets/embed/ei.js"></script>

<!-- end codepen embed -->

<h1 id="golocalisation">Géolocalisation</h1>
<p>La géolocalisation nous permet de connaître la position de l’utilisateur (ses coordonnées géographiques), elle fait partie de la spécification HTML5. Comme nous avons besoin d’un point de départ pour notre itinéraire, nous allons utiliser cette géolocalisation.</p>

<p>L’objet géolocalisation fait partie des objets du navigateur. La plupart des navigateurs modernes prennent en charge la géolocalisation, mais à partir de la version 50, Chrome (avec probablement d’autres navigateurs) n’en permet plus l’accès depuis une origine non sécurisée. Cela signifie qu’un site public sans SSL (HTTP, pas HTTPS) ne peut plus utiliser la géolocalisation dans Chrome. Heureusement pour nous, Firefox le permet toujours, et localhost est une origine sécurisée, donc le tutoriel devrait fonctionner même sur Chrome.</p>

<p>Ajoutez à script.js :</p>

<pre><code class="language-javascript">// define global variables
var pos = [];
var posMarker;
var addressPos = [];
var addressMarker;
var bikeRouteMM;
var bikeRouteII;

// function for successful geolocation
function geoSuccess(position) {
  pos = [position.coords.latitude, position.coords.longitude];

  // tell map to go to the new position
  map.panTo(pos);

  // remove the marker if it is already on the map
  if (posMarker) {map.removeLayer(posMarker);};

  // create a new mapbox marker for our position, add it to the map
  posMarker = L.marker(pos, {
    icon: L.mapbox.marker.icon({
      'marker-size': 'large',
      'marker-symbol': 'bicycle',
      'marker-color': '#fa0',
    }),
  }).addTo(map);
}

// function for geolocation error
function geoError(err) {
  // tell user of issue
  alert('Sorry, no position available.');
}

// use html5 geolocation
function getUserLocation() {
  if ('geolocation' in navigator) {
    navigator.geolocation.getCurrentPosition(geoSuccess, geoError);
  } else {
    console.log('No geolocation available');
  }
}

// call the actual function now
getUserLocation();
</code></pre>

<p>Attention à l’usage des fonctions de “callback” (geoSuccess and geoError dans ce cas). Les fonctions en javascript peuvent être soit <em>synchrones</em> soit <em>asynchrones</em>. Les fonctions synchrones sont exécutées entièrement avant de permettre le passage à l’étape suivante. Cela ne pose pas de problème dans beaucoup de cas car la durée d’exécution de beaucoup de fonctions est négligeable. Mais pour des fonctions plus lourdes (surtout celles qui ont besoin d’aller chercher des données), on ne souhaite pas que l’application ait finit d’obtenir toutes ses données avant de passer à la suite. C’est pourquoi on demande à l’application d’obtenir ses premières données et de les traiter dès leur réception tout en continuant à exécuter le script.</p>

<p>Et les résultats (essayez firefox, chrome 50+ ne function plus ):</p>

<!-- codepen embed -->
<p data-height="500" data-theme-id="0" data-slug-hash="pbJYZK" data-default-tab="result" data-user="abenrob" data-embed-version="2" data-preview="true" class="codepen"></p>
<!-- end codepen embed -->

<h1 id="apis">APIs</h1>
<p>Une API (ou interface de programmation) est un ensemble d’instructions que nous pouvons utiliser pour communiquer avec une application. Récemment, on utilise le terme API pour décrire un ensemble d’URLs qui peuvent être utilisées pour créer, lire, mettre à jour et supprimer des données distantes. Dans notre cas, nous voulons seulement récupérer des données (adresses et itinéraires) au format <a href="https://fr.wikipedia.org/wiki/JavaScript_Object_Notation">JSON</a> (JavaScript Object Notation). Ce format humainement lisible permet de décrire des structures des données tout en restant facile à utiliser par l’interpréteur Javascript.</p>

<p>Pour accéder à ces données distantes, nous allons utiliser <a href="https://jquery.com/">jQuery</a>, une bibliothèque javascript qui aide à traverser le HTML, gérer les événements, et accéder aux données avec <a href="https://fr.wikipedia.org/wiki/Ajax_(informatique)">Ajax</a> (asynchronous javascript and xml, mais utile pour JSON aussi). jQuery a une classe spécifique pour ajax+json <a href="http://api.jquery.com/jquery.getjson/">getJSON</a> que nous allons utiliser pour chercher nos données. getJSON s’utilise comme ça :</p>

<pre><code class="language-javascript">$.getJSON( 'url/des/données/', function( json ) {
  // partie asynchronome
  console.log('Regardez mes données: ' + json.dataname);
 });
</code></pre>

<h1 id="adresses">Adresses</h1>
<p>Afin d’obtenir un itinéraire nous avons besoin de deux points : départ et arrivée. Nous avons le point de départ (notre géolocalisation) et pour l’arrivée nous allons utiliser la Basse Adresse Nationale : <a href="https://adresse.data.gouv.fr/">BAN</a></p>

<p>Nous allons utiliser également la fonction getJSON et afficher les résultats sur la console afin de les explorer. (vous pouvez supprimer la ligne “getUserLocation();” dans script.js, nous l’utiliserons plus tard).</p>

<p>Ajoutez ensuite JQuery à index.html, juste après la référence à style.css</p>

<pre><code class="language-markdown">&lt;script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.0/jquery.min.js'&gt;&lt;/script&gt;
</code></pre>

<p>Rechargez votre page et ouvrez ensuite la console <a href="http://webmasters.stackexchange.com/questions/8525/how-to-open-the-javascript-console-in-different-browsers">voir cette question sur Stackoverflow pour un peu d’aide</a>.</p>

<p>Collez ensuite ce qui suit et appuyez sur entrée.</p>

<pre><code class="language-javascript">$.getJSON('https://api-adresse.data.gouv.fr/search/?q=31 rue gustave eiffel', function (data) {
  console.log(data);
});
</code></pre>

<p>Nous pouvons voir les résultats ici (chaque item est une adresse trouvée) :</p>

<!-- json embed -->
<div id="getJson1" class="btn btn-sm btn-primary">obtenir JSON</div>
<div id="json1" class="well json-block"></div>
<script>$('#getJson1').click(function() {
  $.getJSON('https://api-adresse.data.gouv.fr/search/?q=31 rue gustave eiffel', function (data) {
    document.getElementById("json1").innerHTML = JSONTree.create(data);
  });
});</script>

<!-- end json embed -->

<p>L’API de la BAN nous permet d’apporter une précision sur la localisation de nos résultats en fournissant en premier les adresses correspondantes les plus proches. Essayez le même code que précédemment dans la console (pour cela appuyez sur la flèche du haut pour accéder aux commandes précédentes dans la console) mais en ajoutant latitude, longitude à la fin de l’URL de requête comme suit :  <code>&amp;lat=45.186502&amp;lon=5.736339</code> Vous pouvez voir comme le résultat Grenoble arrive en premier ?</p>

<p>Construisons maintenant une fonction pour placer un point sur la carte correspondant à une adresse recherchée.</p>

<p>Ajoutez à script.js :</p>

<pre><code class="language-javascript">// get address from BAN database https://adresse.data.gouv.fr/api/
function getBanAddressCoords(q, lat, lon, callback) {
  // build uri for ban data
  var uri = 'https://api-adresse.data.gouv.fr/search/?q=' + q;
  if (lat &amp;&amp; lon) { uri = uri + '&amp;lat=' + lat + '&amp;lon=' + lon; };

  $.getJSON(uri, function (data) {
    // grab the first address (feature);
    var coords = data.features[0].geometry.coordinates;

    // remove marker from map if it exists
    if (addressMarker) {map.removeLayer(addressMarker);};

    addressPos = [coords[1], coords[0]];

    // create a new mapbox marker for our position, add it to the map
    addressMarker = L.marker(addressPos, {
      icon: L.mapbox.marker.icon({
        'marker-size': 'large',
        'marker-symbol': 'rocket',
        'marker-color': '#66ccff',
      }),
    }).addTo(map);

    if (pos.length &gt; 0) {
      // we have a position, use it to zoom to both points
      var group = new L.featureGroup([posMarker, addressMarker]);
      map.fitBounds(group.getBounds().pad(0.5));
    } else {
      // no position, just pan to new point
      map.panTo(addressPos);
    }

    callback();
  });
};

getBanAddressCoords('31 rue gustave eiffel', 45.186502, 5.736339, function () {
  console.log('point added');
});
</code></pre>

<p>Et les résultats :</p>

<!-- codepen embed -->
<p data-height="500" data-theme-id="0" data-slug-hash="EyVjbb" data-default-tab="result" data-user="abenrob" data-embed-version="2" data-preview="true" class="codepen"></p>
<!-- end codepen embed -->

<h1 id="itinraires">Itinéraires</h1>
<p>Maintenant que l’on sait obtenir les points de départ et d’arrivée, nous pouvons maintenant explorer les APIs d’itinéraires</p>

<h2 id="mtromobilit">Métromobilité</h2>
<p>L’<a href="http://www.metromobilite.fr/pages/opendata/OpenDataApi.html">API Métromobilité</a> a une ressource <a href="http://www.metromobilite.fr/pages/opendata/OpenDataApi.html#Otp">Horaires OTP</a>, qui utilise <a href="http://www.opentripplanner.org/">OpenTripPlanner</a> pour fournir les itinéraires multimodaux avec leur données. Pour chercher un itinéraire vélo, il faut fournir les coordonnées de départ, celles de l’arrivé et le mode de transport, qui pour nous sera ‘BICYCLE’.</p>

<p>Nous allons essayer. Collez ensuite ce qui suit et appuyez sur entrée.</p>

<pre><code class="language-javascript">var results;
$.getJSON('http://data.metromobilite.fr/otp/routers/default/plan?mode=BICYCLE&amp;fromPlace=45.1836656,5.703573&amp;toPlace=45.195926,5.735935', function (data) {
  console.log(data);results = data;
});
</code></pre>

<p>Nous pouvons voir les résultats ici (les itinéraires sont dans plan.itineraries) :</p>

<!-- json embed -->
<div id="getJson2" class="btn btn-sm btn-primary">obtenir JSON</div>
<div id="json2" class="well json-block"></div>
<script>$('#getJson2').click(function() {
  $.getJSON('http://data.metromobilite.fr/otp/routers/default/plan?mode=BICYCLE&fromPlace=45.1836656,5.703573&toPlace=45.195926,5.735935', function (data) {
    document.getElementById("json2").innerHTML = JSONTree.create(data);
  });
});</script>

<!-- end json embed -->

<p>Pour la partie cartographique, nous voulons la géométrie du trajet. Comme le résultat a été affecté a une variable, nous pouvons jouer avec les données dans la console. Pour voir le tracé de l’itinéraire, tapez <code>results.plan.itineraries[0].legs[0].legGeometry.points</code> dans la console. Nous voyons une chaîne de caractères encodée, qui contient le tracé. Voyez aussi <code>results.plan.itineraries[0].legs[0].steps</code> pour voir les coordonnées et instructions de direction.</p>

<p>Attendez ! Ce tracé était n’importe quoi ! Pour rendre le tracé utile, il faut le décoder. Mapbox a créé une bibliothèque pour faire cela : <a href="https://github.com/mapbox/polyline">polyline</a>.</p>

<p>Ajoutez ensuite polyline à index.html, juste après la référence à jQuery</p>

<pre><code class="language-markdown">&lt;script src='https://rawgithub.com/mapbox/polyline/master/src/polyline.js'&gt;&lt;/script&gt;
</code></pre>

<p>Dans script.js, vous pouvez effacer l’appel de la function getBanAddressCoords(). On mettra ceci à la fin du fichier :</p>

<pre><code class="language-javascript">// function to clear routes from map
function clearRoutes() {
  if (bikeRouteMM) {map.removeLayer(bikeRouteMM);};

  if (bikeRouteII) {map.removeLayer(bikeRouteII);};
};

function getMetromobiliteRoute(fromPos, toPos, callback) {
  clearRoutes();

  // build uri for API
  var uri = 'http://data.metromobilite.fr/otp/routers/default/plan' +
            '?mode=BICYCLE&amp;fromPlace=' + fromPos + '&amp;toPlace=' + toPos;

  $.getJSON(uri, function (data) {
    // get all node points from first returned trip
    var pts = data.plan.itineraries[0].legs[0].legGeometry.points;

    //use mapbox.polyline to decode encoded polyline string
    var decoded = polyline.decode(pts);

    // create polyline, assign color, bind popup, add to map
    bikeRouteMM = L.polyline(decoded, { color: '#21881c' }).bindPopup('Metromobilité').addTo(map);

    callback();
  });
};

getMetromobiliteRoute([45.1836656,5.703573], [45.195926,5.735935], function(){
  console.log('route completed')
});
</code></pre>

<p>Ce qui donne comme résultat :</p>

<!-- codepen embed -->
<p data-height="500" data-theme-id="0" data-slug-hash="gMamNd" data-default-tab="result" data-user="abenrob" data-embed-version="2" data-preview="true" class="codepen"></p>
<!-- end codepen embed -->

<h2 id="itinisre">ItinIsère</h2>
<p>L’ <a href="http://www.itinisere.fr/fr/api-open-services/169/OpenData/openservicesml">API ItinIsère</a> propose une fonction appelée <a href="http://www.itinisere.fr/fr/api-open-services/169/OpenData/openservices#!/journeyplanner/v2/BikeTripJsonGET_get_1">JourneyPlanner/v2/BikeTrip/json</a> que l’on peut utiliser pour obtenir des itinéraires vélo à partir des données ItinIsère. Pour obtenir un itinéraire vélo nous devons fournir des coordonnées de départ, d’arrivée, une date de départ, un horaire de départ et un algorithme. Dans notre cas nous allons utiliser l’algorithme ‘FASTEST’. Itinisère requiert une clé d’authentification pour pouvoir être utilisée, vous pouvez utiliser la clé Maptime-Alpes, mais vous devrez demander la vôtre pour vos propres développement futurs.</p>

<p>Essayons en copiant/collant dans la console :</p>

<pre><code class="language-javascript">var results;
$.getJSON('http://www.itinisere.fr/webServices/TransinfoService/api/journeyplanner/v2/BikeTrip/json?DepLat=45.1837081&amp;DepLon=5.7035291&amp;ArrLat=45.195926&amp;ArrLon=5.735935&amp;Date=2016-06-07&amp;DepartureTime=10-48&amp;user_key=0016bf2ff47f630bab2e65bba954c091&amp;Algorithm=FASTEST&amp;callback&amp;callback=?', function (data) {
  console.log(data);results = data;
});
</code></pre>

<p>On peut voir les résultats ci-après (les segments de l’itinéraire sont dans trips.Trip[0].sections.Section[0].Leg.pathLinks.PathLink):</p>

<!-- json embed -->
<div id="getJson3" class="btn btn-sm btn-primary">obtenir JSON</div>
<div id="json3" class="well json-block"></div>
<script>$('#getJson3').click(function() {
  $.getJSON('http://www.itinisere.fr/webServices/TransinfoService/api/journeyplanner/v2/BikeTrip/json?DepLat=45.1837081&DepLon=5.7035291&ArrLat=45.195926&ArrLon=5.735935&Date=2016-06-07&DepartureTime=10-48&user_key=0016bf2ff47f630bab2e65bba954c091&Algorithm=FASTEST&callback&callback=?', function (data) {
    document.getElementById("json3").innerHTML = JSONTree.create(data);
  });
});</script>

<!-- end json embed -->

<p>Là encore, pour l’exercice de cartographie, on souhaite le tracé du parcours. Pour voir la forme géométrique, tapez  <code>results.trips.Trip[0].sections.Section[0].Leg.pathLinks.PathLink[0]</code> dans la console. On obtient dans le champ “Geometry” une chaîne de caractères de type “LINESTRING ()” et qui contient le tracé spécifique du segment d’itinéraire. Nous obtenons également les instructions de direction du segment qui doivent être fournies à l’utilisateur.</p>

<p>Le tracé est présenté au format  <a href="https://en.wikipedia.org/wiki/Well-known_text">WKT (Well-Known text)</a>. Pour l’utiliser dans notre carte nous avons besoin de convertir le WKT dans un format lisible pour la carte. Mapbox (encore) a créé une bibliothèque  (<a href="https://github.com/mapbox/wellknown">wellknown</a>) pour convertir le WKT en geoJSON mais cela nous oblige à avoir ces caractéristiques pour chaque segment alors que l’on souhaite un simple tracé. En utilisant les fonctions  javascript <em>map</em> et <em>reduce</em> on peut convertir le WKT avec <em>map</em>, combiner tous les segments en une ligne avec <em>reduce</em> et ensuite intervertir [longitude,latitude] en [latitude.longitude] avec un autre <em>map</em>.</p>

<p>Ajoutez ensuite wellknown à index.html, juste après la référence à polyline.</p>

<pre><code class="language-markdown">&lt;script src='https://rawgithub.com/mapbox/wellknown/master/wellknown.js'&gt;&lt;/script&gt;
</code></pre>

<p>Dans script.js (vous pouvez enlever si vous préférez l’appel de getMetromobiliteRoute() ) on mettra ceci à la fin du fichier :</p>

<pre><code class="language-javascript">function getItinisereRoute(fromPos, toPos, algorithm, callback) {
  clearRoutes();

  // get date elements to fill in date/time requirement of API
  var d = new Date();
  var dateString = d.toISOString().slice(0, 10);
  var timeString = d.getHours() + '-' + (d.getMinutes() &lt; 10 ? '0' : '') + d.getMinutes();

  // build uri for API
  var uri = 'http://www.itinisere.fr/webServices/TransinfoService/api/journeyplanner/v2/' +
            'BikeTrip/json?DepLat=' + fromPos[0] + '&amp;DepLon=' + fromPos[1] +
            '&amp;ArrLat=' + toPos[0] + '&amp;ArrLon=' + toPos[1] +
            '&amp;Date=' + dateString + '&amp;DepartureTime=' + timeString +
            '&amp;user_key=0016bf2ff47f630bab2e65bba954c091&amp;Algorithm=' + algorithm + '&amp;callback=?';

  $.getJSON(uri, function (data) {
    // get links for first trip
    var pathLinks = data.trips.Trip[0].sections.Section[0].Leg.pathLinks.PathLink;

    // isolate geometry from WKT string
    var linkCoords = pathLinks.map(function (link) {
      return wellknown.parse(link.Geometry).coordinates;
    });

    // combine all legs into one line
    var coords = linkCoords.reduce(function (a, b) {
      return a.concat(b);
    });

    // swap long/lat to lat/log
    var swappedCoords = coords.map(function (pair) {
      return pair.reverse();
    });

    // create polyline, assign color, bind popup, add to map
    bikeRouteII = L.polyline(swappedCoords, { color: '#044571' }).bindPopup('ItinIsère').addTo(map);

    callback();
  });
};

getItinisereRoute([45.1836656,5.703573], [45.195926,5.735935], 'FASTEST', function(){
  console.log('route completed');
})
</code></pre>

<p>Ce qui donne comme résultat :</p>

<!-- codepen embed -->
<p data-height="500" data-theme-id="0" data-slug-hash="EyVmEb" data-default-tab="result" data-user="abenrob" data-embed-version="2" data-preview="true" class="codepen"></p>
<!-- end codepen embed -->

<h1 id="assemblage">Assemblage</h1>

<p>Maintenant que toutes ces parties ont été exécutées nous avons besoin maintenant de les assembler. Il nous faut créer les boutons et entrées qui vont déclencher chacune des étapes : get location, get address, get métromobilité route, get itinisère route.</p>

<p>Nous utiliserons les bibliothèques Bootstrap pour créer une barre de navigation sympathique et appliquer un thème aux boutons pour chacune des actions.
Pour retrouvez les librairies Bootstrap : nous utiliserons une version déjà stylisée de Bootstrap, fournie par <a href="https://bootswatch.com/">bootswatch</a>).</p>

<p>La balise &lt;head&gt; du fichier index.html devra ressembler à ça :</p>

<pre><code class="language-markdown">&lt;head&gt;
  &lt;meta charset=utf-8 /&gt;
  &lt;title&gt;VéloIsère&lt;/title&gt;
  &lt;meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' /&gt;
  &lt;link href='https://maxcdn.bootstrapcdn.com/bootswatch/3.3.6/superhero/bootstrap.min.css' rel='stylesheet' /&gt;
  &lt;link href='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.css' rel='stylesheet' /&gt;
  &lt;link href='style.css' rel='stylesheet' /&gt;
  &lt;script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.0/jquery.min.js'&gt;&lt;/script&gt;
  &lt;script src='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.6/js/bootstrap.min.js'&gt;&lt;/script&gt;
  &lt;script src='https://rawgithub.com/mapbox/polyline/master/src/polyline.js'&gt;&lt;/script&gt;
  &lt;script src='https://rawgithub.com/mapbox/wellknown/master/wellknown.js'&gt;&lt;/script&gt;
  &lt;script src='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.js'&gt;&lt;/script&gt;
&lt;/head&gt;
</code></pre>

<p>Pour ajouter la barre de navigation, remplacez votre balise &lt;body&gt; par ceci :</p>

<pre><code class="language-markdown">&lt;body&gt;
  &lt;div class="navbar navbar-default navbar-static-top"&gt;
    &lt;div class="container"&gt;
      &lt;div class="navbar-header"&gt;
        &lt;div class="navbar-brand"&gt;
          VéloIsère
        &lt;/div&gt;

        &lt;button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navHeaderCollapse"&gt;
          &lt;span class="icon-bar"&gt;&lt;/span&gt;
          &lt;span class="icon-bar"&gt;&lt;/span&gt;
          &lt;span class="icon-bar"&gt;&lt;/span&gt;
        &lt;/button&gt;
      &lt;/div&gt;
      &lt;div class="collapse navbar-collapse navHeaderCollapse"&gt;
        &lt;ul class="nav navbar-nav navbar-right"&gt;
          &lt;li&gt;&lt;button id="get_position" type="button" class="btn btn-primary"&gt;Get position&lt;/button&gt;&lt;/li&gt;
          &lt;li&gt;&lt;form class="navbar-form" role="search"&gt;
            &lt;div class="form-group"&gt;
              &lt;input id="address_search" type="text" class="form-control" placeholder="Search"&gt;
            &lt;/div&gt;
            &lt;button id="get_address" class="btn btn-success" onclick="return false;"&gt;Get address&lt;/button&gt;
          &lt;/form&gt;&lt;/li&gt;
          &lt;li class="dropdown"&gt;
            &lt;button id="route-menu" class="dropdown-toggle btn btn-info" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false" disabled&gt;Get route &lt;span class="caret"&gt;&lt;/span&gt;&lt;/button&gt;
            &lt;ul class="dropdown-menu"&gt;
              &lt;li&gt;&lt;button id="II-route" class="menu-btn btn btn-info"&gt;Itinisère&lt;/button&gt;&lt;/li&gt;
              &lt;li&gt;&lt;button id="MM-route" class="menu-btn btn btn-info"&gt;Métromobilité&lt;/button&gt;&lt;/li&gt;
            &lt;/ul&gt;
          &lt;/li&gt;
        &lt;/ul&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;

  &lt;div id="map"&gt;&lt;/div&gt;
  &lt;script src="script.js"&gt;&lt;/script&gt;
&lt;/body&gt;
</code></pre>

<p>Votre style.css doit ressembler à ceci :</p>

<pre><code class="language-css">body {
  margin: 0;
  padding: 0;
}
.navbar {
  z-index: 2000;
}
.menu-btn {
  width: 100%;
}
#map {
  position: absolute;
  top: 41px;
  bottom: 0;
  width: 100%;
}
</code></pre>

<p>Pour déclencher les actions nous allons utiliser une fonction jQuery qui réagit au click : Quand on clique sur un élémént en particulier, l’application lance une action particulière.</p>

<pre><code class="language-javascript">$('#element_id').click(function () {
  // fait qqch maintenant !
}
</code></pre>

<p>Ajoutez ceci à la fin du fichier script.js :</p>

<pre><code class="language-javascript">// function to close mobile nav menu
function closeNav() {
  $('.navHeaderCollapse').collapse('hide');
};

// jQuery click actions
// on get address click
$('#get_address').click(function () {
  // remove any routes
  clearRoutes();

  // get value of search box
  var search = $('#address_search').val();

  // call address function
  getBanAddressCoords(search, pos[0] || 45.186502, pos[1] || 5.736339, function () {
    $('#route-menu').prop('disabled', false);
  });
});

// on get location button click
$('#get_position').click(function () {
  // remove any routes
  clearRoutes();
  getUserLocation();
});

// on dropdown select, get the route
$('#MM-route').click(function () {
  getMetromobiliteRoute(pos, addressPos, function () {
    closeNav();
  });
});

// on dropdown select, get the route
$('#II-route').click(function () {
  getItinisereRoute(pos, addressPos, 'FASTEST', function () {
    closeNav();
  });
});
</code></pre>

<p>Nous avons une vraie application ! (Essayez avec firefox pour le coté  géolocalisation)</p>

<!-- codepen embed -->
<p data-height="500" data-theme-id="0" data-slug-hash="rLOmQG" data-default-tab="result" data-user="abenrob" data-embed-version="2" data-preview="true" class="codepen"></p>
<!-- end codepen embed -->

<h2 id="fin-">Fin !</h2>

</div>
<script src="https://code.jquery.com/jquery-1.11.1.min.js" type="text/javascript"></script>
<script>
  $(document).ready(function(){
	  // sticky header with generated ids and anchors for <h1> tags
	  var title = $("#page-title");
	  title.after($("<div class='pull-left tutorial-navs'><ul id='tutorial-nav'></ul></div>"));

	  var heads = document.getElementsByTagName("h1");
	  var tutNav = document.getElementById("tutorial-nav");
	  for (var i=0; i<heads.length; i++) {
	    if(heads[i].className!="tutorial-title") {
	      var text = heads[i].innerHTML;
	      var target = nice(text);

	      // create list item and anchor
	      var item = document.createElement("li");
	      var anchor = document.createElement("a");
	      anchor.href = "#"+target;
	      anchor.innerHTML = text;
	      item.appendChild(anchor);
	      tutNav.appendChild(item);

	      // add id to h1 element in page
	      heads[i].id = target;
	    }
	  }

	  // collapse sections
	  $(".collapse-button").on("click", function(){
	    $(this).next(".collapse").slideToggle(200);
	  });

	  // click navigation anchors and animate scroll
	  $('a').on('click', function(event){
	    if($(this).attr('href').indexOf('#')>-1) {
	      event.preventDefault();
	      var id = $(this).attr("href");
	      var top = $(id).offset().top - 160;
	      $("html, body").animate({
	        scrollTop: top
	      }, 500); // you can set any time here
	    }
	  });

	  var nav = $("#tutorial-nav");
	  $("#tutorial-nav li:eq(0) a").addClass('nav-active');
	  var aChildren = $("#tutorial-nav li").children();
	  var aArray = [];
	  var top = nav.offset().top;

	  for (var i=0; i < aChildren.length; i++) {
	      var aChild = aChildren[i];
	      var ahref = $(aChild).attr('href');
	      aArray.push(ahref);
	  }

	});

	function nice(str) {
	  var newString = str.replace(/[^A-Z0-9]+/ig, "-").toLowerCase();
	  return newString;
	}
</script>


        

<div id="footerwrap">
    <div class="container">
        <div class="row">
            <div class="col-sm-6">
                <h4>À propos</h4>
                <div class="hline-w"></div>
                <p>We make maps in the Alps. On fait de la cartographie dans les Alpes!</p>
            </div>
            <div class="col-sm-6">
            



  


<h4>Réseaux sociaux</h4>
<div class="hline-w"></div>
<p>
    
        <a href="https://twitter.com/MaptimeAlpes" class="btn-social btn-outline"><i class="icon-twitter"></i></a>
    
        <a href="https://github.com/MaptimeAlpes" class="btn-social btn-outline"><i class="icon-github"></i></a>
    
        <a href="http://www.meetup.com/MaptimeAlpes/" class="btn-social btn-outline"><i class="icon-meetup"></i></a>
    
</p>
            </div>
        </div>
    </div>
</div>

    </body>
</html>
