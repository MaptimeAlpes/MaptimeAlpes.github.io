

<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="We make maps in the Alps. On fait de la cartographie dans les Alpes!">
    <meta name="author" content="Maptime-Alpes Contributors">
    <link rel="apple-touch-icon-precomposed" sizes="57x57" href="/assets/img/apple-touch-icon-57x57.png" />
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/assets/img/apple-touch-icon-114x114.png" />
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/assets/img/apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/img/apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon-precomposed" sizes="120x120" href="/assets/img/apple-touch-icon-120x120.png" />
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="/assets/img/apple-touch-icon-152x152.png" />
    <link rel="icon" type="image/png" href="/assets/img/favicon-32x32.png" />
    <link rel="icon" type="image/png" href="/assets/img/favicon-16x16.png" />
    <meta name="application-name" content="Maptime-Alpes"/>
    <meta name="msapplication-TileColor" content="#FFFFFF" />
    <meta name="msapplication-TileImage" content="/assets/img/mstile-144x144.png" />

    <title>MaptimeAlpes - Vélo Isère</title>

    <!-- Custom styles for this template -->
    <link href="/assets/css/style.css" rel="stylesheet">
    <link href="/assets/css/fontcustom/fontcustom.css" rel="stylesheet">
    
    <link href="/assets/css/prism.css" rel="stylesheet">
    <link rel="stylesheet" href="https://rawgit.com/lmenezes/json-tree/master/dist/css/jsontree.css" />
    <script src="https://rawgit.com/lmenezes/json-tree/master/dist/js/jsontree.min.js"></script>
    

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <script src="/assets/js/modernizr.js"></script>
    <script src="/assets/js/prism.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script src="/assets/js/bootstrap.min.js"></script>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-55615382-1', 'auto');
  ga('send', 'pageview');

	var _gaq = _gaq || [];
	_gaq.push(['_setAccount', 'UA-55615382-1']);

	// set custom variables
	_gaq.push(['_setCustomVar',
      1,
      'Locale',
      'en',
      3                    // Sets the scope to page-level.  Optional parameter.
   ]);

	// track page view
	_gaq.push(['_trackPageview']);

	(function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	})();
</script>


</head>

    <body>
        

<!-- Fixed navbar -->
<div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">

      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">
        <svg id="mt_pin" viewBox="0 0 29 41" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <path d="M12.7656702,16.506016 C13.1349844,16.6854737 13.5496704,16.7861333 13.9878667,16.7861333 C15.534264,16.7861333 16.7878667,15.5325306 16.7878667,13.9861333 C16.7878667,12.7669958 16.0087129,11.7298393 14.9212,11.3454587 L14.9212,5.58613333 L13.9878667,4.6528 L13.0545333,5.58613333 L13.0545333,11.3454587 C11.9670205,11.7298393 11.1878667,12.7669958 11.1878667,13.9861333 C11.1878667,14.4124673 11.2831501,14.8165465 11.4535834,15.1782375 L8.29929023,18.3325306 L8.29929023,19.6524633 L9.61922289,19.6524633 L12.7656702,16.506016 Z M14.0160043,0.016 C17.8989916,0.016 21.2027378,1.37751175 23.9272427,4.10053526 C26.6517476,6.82355876 28.014,10.1255085 28.014,14.0063846 C28.014,15.9468226 27.5282925,18.1690449 26.5568776,20.6730513 C25.5854627,23.1770577 24.4109458,25.5248141 23.0333271,27.7163205 C21.6557084,29.9078269 20.293456,31.9577735 18.9465698,33.8661603 C17.5996836,35.774547 16.4565674,37.2923088 15.5172212,38.4194455 L14.014,40.016 C13.6385288,39.5779658 13.137455,38.9990395 12.5107788,38.2792212 C11.8841026,37.5594028 10.7563527,36.119766 9.12752899,33.9603109 C7.49870532,31.8008558 6.07365163,29.7035 4.85236793,27.6682436 C3.63108423,25.6329872 2.51936865,23.33264 1.51722119,20.7672019 C0.515073729,18.2017639 0.014,15.9481581 0.014,14.0063846 C0.014,10.1255085 1.37625245,6.82355876 4.10075734,4.10053526 C6.82526223,1.37751175 10.1290084,0.016 14.0119957,0.016 L14.0160043,0.016 Z M13.9878667,24.2528 C19.6579901,24.2528 24.2545333,19.6562568 24.2545333,13.9861333 C24.2545333,8.3160099 19.6579901,3.71946667 13.9878667,3.71946667 C8.31774324,3.71946667 3.7212,8.3160099 3.7212,13.9861333 C3.7212,19.6562568 8.31774324,24.2528 13.9878667,24.2528 Z" id="Shape" fill="#231F20"></path>
    </g>
</svg>

        <span>Maptime Alpes!</span>
      </a>
    </div>
    <div class="navbar-collapse collapse navbar-right">
      <ul class="nav navbar-nav">
        
        <li>
          <a href="/en/">Home</a>
        </li>
        
        <li>
          <a href="/en/blog/">Blog</a>
        </li>
        
        <li>
          <a href="/en/workshops/">Workshops</a>
        </li>
        
        <li>
          <a href="/en/about/">About</a>
        </li>
        
        <li>
          <a href="http://www.maptime.io">Maptime.io</a>
        </li>
        
        <li><div class="locale-links">
          
            
              <a href="/"><img class="flag" src="/assets/img/fr.png"/>
            
              </a>
          
            
              <a href="/en"><img class="flag" src="/assets/img/us.png"/>
            
              </a>
          
        </div></li>
      </ul>
    </div><!--/.nav-collapse -->
  </div>
</div>

        

<div id="miniheaderwrap" class='tut'>
    <div class="mini-map-banner">
    	<div class="container">
        	<div class="pull-left mini-text-block">
            	<h3 id="page-title" class="pull-left">Vélo Isère</h3>
            </div>
        </div>
    </div>
</div>

<div class="tutorial container" id="tutorial">
<p class="tut_auth_date"><csmall>

09 June, 2016
 by <a href="http://www.github.com/abenrob" target="_blank">abenrob</a>

</csmall></p>
<div class="hline"></div>
<p>In this tutorial, we are going to explore the components of route-finding APIs, and build a simple application to find a bike route between two points. We are going to use html5 geolocation to pin-point our location, the <a href="https://adresse.data.gouv.fr/api/">BAN</a> database of french addresses to find our destination, and <a href="http://www.itinisere.fr/fr/api-open-services/169/OpenData/openservices">itinIsère</a> and <a href="http://www.metromobilite.fr/pages/opendata/OpenDataApi.html">métromobilité</a> to find the actual routes.
<!--more--></p>

<h2 id="house-keeping">House keeping</h2>

<p>To successfully follow this tutorial you need a text editor (such as Notepad++ or Atom). Go ahead and use your personal favorite, or if you don’t have one installed,
download <a href="https://atom.io/">Atom Editor</a>.</p>

<p>You will also need to be able to run a local webserver in order to access remote resources, such as APIs. The easiest way to do this if you have python installed is to navigate in the console to the root of the project, and run <code>python -m SimpleHTTPServer</code>. This will enable a webpage at <a href="http://localhost:8000">http://localhost:8000</a>.</p>

<h1 id="getting-started">Getting Started</h1>

<h2 id="websites">Websites</h2>
<p>Since we will be building a simple web application in the workshop, we should touch on some of the components of a website first.</p>

<p>A basic website is comprised of HTML, css, and javascript files. The HTML (Hyper Text Markup Language) is the structure of the page - it indicates what goes where, as well as referencing the other components of the page. CSS (Cascading Style Sheets) are the style rules we put in place to dictate how we want the HTML elements to appear. Javascript is a programming language used by websites to <em>do</em> things - get data, manage interactions, format data, etc. <a href="https://jquery.com/">jQuery</a> is a javascript library that can make document manipulation, event handling and data fetching much simpler. <a href="http://getbootstrap.com/">Bootstrap</a> is a framework that includes css and javascript helpers to make styling a website much easier as well (without developing the styles ourselves.) This can be great for prototyping sites, or making a decent looking tutorial in less time ;).</p>

<h2 id="the-basic-webmap">The basic webmap</h2>
<p>We are also going to use <a href="https://www.mapbox.com/mapbox.js/api/v2.4.0/">MapboxJS</a> (which extends <a href="http://leafletjs.com/">LeafletJS</a>) to get the map part of the application in place in very few lines of code.</p>

<p>In our project root, we will create a file called ‘index.html’, a file called ‘style.css’ and a file called ‘script.js’.</p>

<p>In index.html we put this content:</p>

<pre><code class="language-markup">&lt;!DOCTYPE html&gt;
&lt;html&gt;

&lt;head&gt;
  &lt;meta charset=utf-8 /&gt;
  &lt;title&gt;VéloIsère&lt;/title&gt;
  &lt;meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' /&gt;
  &lt;link href='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.css' rel='stylesheet' /&gt;
  &lt;link href='style.css' rel='stylesheet' /&gt;
  &lt;script src='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.js'&gt;&lt;/script&gt;
&lt;/head&gt;

&lt;body&gt;
  &lt;div id="map"&gt;&lt;/div&gt;
  &lt;script src="script.js"&gt;&lt;/script&gt;
&lt;/body&gt;

&lt;/html&gt;
</code></pre>

<p>You will notice in the &lt;head&gt; section that we have included references to our style.css, as well as the mapbox.js. Below the map container (&lt;div id="map"&gt;&lt;/div&gt;) we put our script.js reference, so the mapping library isn’t called before the map container is rendered.</p>

<p>In style.css, put this content:</p>

<pre><code class="language-css">body {
  margin: 0;
  padding: 0;
}
#map {
  position: absolute;
  top: 0;
  bottom: 0;
  width: 100%;
}
</code></pre>

<p>Here we tell the page and map container to be full width and height.</p>

<p>And in script.js, put this content:</p>

<pre><code class="language-javascript">// define mapbox token for map creation
L.mapbox.accessToken = 'pk.eyJ1IjoiYWJlbnJvYiIsImEiOiJEYmh3WWNJIn0.fus8CLBKPBHDvSxiayhJyg';

// set up map
var map = L.mapbox.map('map', 'mapbox.streets')
    .setView([45.186502, 5.736339], 13);
</code></pre>

<p>Here we tell the mapbox library to use our token (mapbox is a subscription service, with a free tier) and to create a map using the ‘streets’ style, centered on Grenoble, and assigned it to the HTML element with the id of ‘map’.</p>

<p>Fire up your webserver, and check out the page we created:</p>

<!-- codepen embed -->
<p data-height="500" data-theme-id="0" data-slug-hash="YWXdPN" data-default-tab="result" data-user="abenrob" data-embed-version="2" data-preview="true" class="codepen"></p>
<script async="" src="//assets.codepen.io/assets/embed/ei.js"></script>

<!-- end codepen embed -->

<h1 id="geolocation">Geolocation</h1>
<p>Geolocation allows us to get the user’s location (in geographic coordinates) and is part of the HTML5 spec. Since we need a starting point for our route, we are going to play with geolocation in the process.</p>

<p>The geolocation object is a part of the browser’s navigator object. Most modern browsers support geolocation, but Chrome 50+ (and probably all the others as well) no longer support it from unsecure origins. That means a public website without SSL (HTTP not HTTPS) can not use geolocation in chrome 50+. Luckily for us, Firefox still supports it, and localhost is a secure origin, so the demo should work locally, even in chrome.</p>

<p>Add to script.js:</p>

<pre><code class="language-javascript">// define global variables
var pos = [];
var posMarker;
var addressPos = [];
var addressMarker;
var bikeRouteMM;
var bikeRouteII;

// function for successful geolocation
function geoSuccess(position) {
  pos = [position.coords.latitude, position.coords.longitude];

  // tell map to go to the new position
  map.panTo(pos);

  // remove the marker if it is already on the map
  if (posMarker) {map.removeLayer(posMarker);};

  // create a new mapbox marker for our position, add it to the map
  posMarker = L.marker(pos, {
    icon: L.mapbox.marker.icon({
      'marker-size': 'large',
      'marker-symbol': 'bicycle',
      'marker-color': '#fa0',
    }),
  }).addTo(map);
}

// function for geolocation error
function geoError(err) {
  // tell user of issue
  alert('Sorry, no position available.');
}

// use html5 geolocation
function getUserLocation() {
  if ('geolocation' in navigator) {
    navigator.geolocation.getCurrentPosition(geoSuccess, geoError);
  } else {
    console.log('No geolocation available');
  }
}

// call the actual function now
getUserLocation();
</code></pre>

<p>Something to notice is the use of callback functions (geoSuccess and geoError in this case). Functions in javascript can be either <em>synchronous</em> or <em>asynchronous</em>. <em>Synchronous</em> functions finish running before allowing the script to move on to the next step. That is fine for many things, as the time to run many functions is unnoticeable. For longer functions (especially those that need to <em>go get data</em>), we don’t want the application to finish getting all the data before moving on. We want to tell the app to get the data, and tell it what to do when the data are successfully received, but to continue running the rest of the script without waiting for the data. This pattern is called <em>asynchronous</em>.</p>

<p>And the results again (try firefox, chrome 50+ will no longer function…)</p>

<!-- codepen embed -->
<p data-height="500" data-theme-id="0" data-slug-hash="pbJYZK" data-default-tab="result" data-user="abenrob" data-embed-version="2" data-preview="true" class="codepen"></p>
<!-- end codepen embed -->

<h1 id="apis">APIs</h1>
<p>An API (Application Programming Interface) is a set of instructions that can be used to tell an application what to do. Recently, API is frequently used to describe a set of routes that can be accessed to get, update or put data from remote sources. In our case, we are only interested in getting data (Addresses and Routes) and in <a href="https://en.wikipedia.org/wiki/JSON">JSON</a> (javascript object notation) format, which is an human-readable data structure which is easy to use and parse in javascript applications.</p>

<p>To access these remote data sources, we are going to use <a href="https://jquery.com/">jQuery</a>, a javascript helper library which is useful for document traversal, user event handling, and data access via <a href="https://en.wikipedia.org/wiki/Ajax_(programming)">Ajax</a> (asynchronous javascript and xml, although we use it for JSON as well). jQuery has a json-specific helper-class called <a href="http://api.jquery.com/jquery.getjson/">getJSON</a> which we will use to get our data. A basic getJSON pattern is written like this:</p>

<pre><code class="language-javascript">$.getJSON( 'url/to/my/data/', function( json ) {
  // this part is the asynchronous callback
  console.log('Look, I got this new data: ' + json.dataname);
 });
</code></pre>

<h1 id="addresses">Addresses</h1>
<p>In order to create a route, we need two points: start and end. We have the start (our geolocation), and for the end, we are going to use <a href="https://adresse.data.gouv.fr/">BAN</a> (la Base Addresse National Française).</p>

<p>We are going to use the getJSON function, and log the results to the console sp we can explore them. (Feel free to delete the “getUserLocation();” line in script.js - we’ll use it later.)</p>

<p>Add jQuery to index.html, right after the style.css reference</p>

<pre><code class="language-markdown">&lt;script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.0/jquery.min.js'&gt;&lt;/script&gt;
</code></pre>

<p>Relead your page, then open the console <a href="http://webmasters.stackexchange.com/questions/8525/how-to-open-the-javascript-console-in-different-browsers">see this SO question for help</a>.</p>

<p>Paste this in the console, and hit enter.</p>

<pre><code class="language-javascript">$.getJSON('https://api-adresse.data.gouv.fr/search/?q=31 rue gustave eiffel', function (data) {
  console.log(data);
});
</code></pre>

<p>We can see the results here (each “feature” is a found address):</p>

<!-- json embed -->
<div id="getJson1" class="btn btn-sm btn-primary">get JSON</div>
<div id="json1" class="well json-block"></div>
<script>$('#getJson1').click(function() {
  $.getJSON('https://api-adresse.data.gouv.fr/search/?q=31 rue gustave eiffel', function (data) {
    document.getElementById("json1").innerHTML = JSONTree.create(data);
  });
});</script>

<!-- end json embed -->

<p>The BAN API allows us to provide locational precision to our results, so we are returned the nearest matches first. Try the same console code from before (press the up arrow when in the console to access previous commands), but add latitude,longitude to the end of the request url like so: <code>&amp;lat=45.186502&amp;lon=5.736339</code>. Notice how the Grenoble result moves to first place?</p>

<p>Let’s build a function to put a point on the map for a found address.</p>

<p>Add to script.js:</p>

<pre><code class="language-javascript">// get address from BAN database https://adresse.data.gouv.fr/api/
function getBanAddressCoords(q, lat, lon, callback) {
  // build uri for ban data
  var uri = 'https://api-adresse.data.gouv.fr/search/?q=' + q;
  if (lat &amp;&amp; lon) { uri = uri + '&amp;lat=' + lat + '&amp;lon=' + lon; };

  $.getJSON(uri, function (data) {
    // grab the first address (feature);
    var coords = data.features[0].geometry.coordinates;

    // remove marker from map if it exists
    if (addressMarker) {map.removeLayer(addressMarker);};

    addressPos = [coords[1], coords[0]];

    // create a new mapbox marker for our position, add it to the map
    addressMarker = L.marker(addressPos, {
      icon: L.mapbox.marker.icon({
        'marker-size': 'large',
        'marker-symbol': 'rocket',
        'marker-color': '#66ccff',
      }),
    }).addTo(map);

    if (pos.length &gt; 0) {
      // we have a position, use it to zoom to both points
      var group = new L.featureGroup([posMarker, addressMarker]);
      map.fitBounds(group.getBounds().pad(0.5));
    } else {
      // no position, just pan to new point
      map.panTo(addressPos);
    }

    callback();
  });
};

getBanAddressCoords('31 rue gustave eiffel', 45.186502, 5.736339, function () {
  console.log('point added');
});
</code></pre>

<p>And the results again:</p>

<!-- codepen embed -->
<p data-height="500" data-theme-id="0" data-slug-hash="EyVjbb" data-default-tab="result" data-user="abenrob" data-embed-version="2" data-preview="true" class="codepen"></p>
<!-- end codepen embed -->

<h1 id="routes">Routes</h1>
<p>Now that we know how to get our start and end points, we can explore the routing APIs.</p>

<h2 id="mtromobilit">Métromobilité</h2>
<p>The <a href="http://www.metromobilite.fr/pages/opendata/OpenDataApi.html">Métromobilité API</a> has a resource called <a href="http://www.metromobilite.fr/pages/opendata/OpenDataApi.html#Otp">Horaires OTP</a>, which uses <a href="http://www.opentripplanner.org/">OpenTripPlanner</a> to provide multimodal route-finding based on their data. To get a bike route, we need only provide start coordinates, end coordinates and mode, which in our case is ‘BICYCLE’.</p>

<p>Let’s try it out. Paste this in the console, and hit enter.</p>

<pre><code class="language-javascript">var results;
$.getJSON('http://data.metromobilite.fr/otp/routers/default/plan?mode=BICYCLE&amp;fromPlace=45.1836656,5.703573&amp;toPlace=45.195926,5.735935', function (data) {
  console.log(data);results = data;
});
</code></pre>

<p>We can see the results here (the routes are in plan.itineraries):</p>

<!-- json embed -->
<div id="getJson2" class="btn btn-sm btn-primary">get JSON</div>
<div id="json2" class="well json-block"></div>
<script>$('#getJson2').click(function() {
  $.getJSON('http://data.metromobilite.fr/otp/routers/default/plan?mode=BICYCLE&fromPlace=45.1836656,5.703573&toPlace=45.195926,5.735935', function (data) {
    document.getElementById("json2").innerHTML = JSONTree.create(data);
  });
});</script>

<!-- end json embed -->

<p>For the mapping exercise, we want the geometry of the trip. Since we assigned the returned data to the results variable, we can play with the data in the console. To see the route geometry, type <code>results.plan.itineraries[0].legs[0].legGeometry.points</code> in the console. We see an encoded string, which contains the geometry of the entire route. Also check out <code>results.plan.itineraries[0].legs[0].steps</code>. This provides coordinates and directions. Think how we could use this to message each part of the route to the user.</p>

<p>Hold on, that geometry is nonsense! To make the route geometry useful, we’ll need to decode it. Mapbox created a helper library to do just that, called <a href="https://github.com/mapbox/polyline">polyline</a>.</p>

<p>Add polyline to index.html, right after the jQuery reference</p>

<pre><code class="language-markdown">&lt;script src='https://rawgithub.com/mapbox/polyline/master/src/polyline.js'&gt;&lt;/script&gt;
</code></pre>

<p>In script.js, you can remove the call to the address function for now. Add these functions to the bottom of the file now (Function to clear any routes from the map, function to create métromobilité route, call to route creator):</p>

<pre><code class="language-javascript">// function to clear routes from map
function clearRoutes() {
  if (bikeRouteMM) {map.removeLayer(bikeRouteMM);};

  if (bikeRouteII) {map.removeLayer(bikeRouteII);};
};

function getMetromobiliteRoute(fromPos, toPos, callback) {
  clearRoutes();

  // build uri for API
  var uri = 'http://data.metromobilite.fr/otp/routers/default/plan' +
            '?mode=BICYCLE&amp;fromPlace=' + fromPos + '&amp;toPlace=' + toPos;

  $.getJSON(uri, function (data) {
    // get all node points from first returned trip
    var pts = data.plan.itineraries[0].legs[0].legGeometry.points;

    //use mapbox.polyline to decode encoded polyline string
    var decoded = polyline.decode(pts);

    // create polyline, assign color, bind popup, add to map
    bikeRouteMM = L.polyline(decoded, { color: '#21881c' }).bindPopup('Metromobilité').addTo(map);

    callback();
  });
};

getMetromobiliteRoute([45.1836656,5.703573], [45.195926,5.735935], function(){
  console.log('route completed')
});
</code></pre>

<p>And the results again:</p>

<!-- codepen embed -->
<p data-height="500" data-theme-id="0" data-slug-hash="gMamNd" data-default-tab="result" data-user="abenrob" data-embed-version="2" data-preview="true" class="codepen"></p>
<!-- end codepen embed -->

<h2 id="itinisre">ItinIsère</h2>
<p>The <a href="http://www.itinisere.fr/fr/api-open-services/169/OpenData/openservicesml">ItinIsère API</a> has a resource called <a href="http://www.itinisere.fr/fr/api-open-services/169/OpenData/openservices#!/journeyplanner/v2/BikeTripJsonGET_get_1">JourneyPlanner/v2/BikeTrip/json</a>, which we can use to get bike routes based on their data. To get a bike route, we need to provide start coordinates, end coordinates, start date, start time and algorithm. In our case, we will use the ‘FASTEST’ algorithm. ItinIsère requires an API key to use their API, which you can request in your profile. For this exercise, we can just use Maptime-Alpes’ key, but you should request your own for future development.</p>

<p>Let’s try it out. Paste this in the console, and hit enter.</p>

<pre><code class="language-javascript">var results;
$.getJSON('http://www.itinisere.fr/webServices/TransinfoService/api/journeyplanner/v2/BikeTrip/json?DepLat=45.1837081&amp;DepLon=5.7035291&amp;ArrLat=45.195926&amp;ArrLon=5.735935&amp;Date=2016-06-07&amp;DepartureTime=10-48&amp;user_key=0016bf2ff47f630bab2e65bba954c091&amp;Algorithm=FASTEST&amp;callback&amp;callback=?', function (data) {
  console.log(data);results = data;
});
</code></pre>

<p>We can see the results here (the route segments are in trips.Trip[0].sections.Section[0].Leg.pathLinks.PathLink):</p>

<!-- json embed -->
<div id="getJson3" class="btn btn-sm btn-primary">get JSON</div>
<div id="json3" class="well json-block"></div>
<script>$('#getJson3').click(function() {
  $.getJSON('http://www.itinisere.fr/webServices/TransinfoService/api/journeyplanner/v2/BikeTrip/json?DepLat=45.1837081&DepLon=5.7035291&ArrLat=45.195926&ArrLon=5.735935&Date=2016-06-07&DepartureTime=10-48&user_key=0016bf2ff47f630bab2e65bba954c091&Algorithm=FASTEST&callback&callback=?', function (data) {
    document.getElementById("json3").innerHTML = JSONTree.create(data);
  });
});</script>

<!-- end json embed -->

<p>Again, for the mapping exercise, we want the geometry of the trip. To see the route geometry, type <code>results.trips.Trip[0].sections.Section[0].Leg.pathLinks.PathLink[0]</code> in the console. We see a “LINESTRING ()” string in the Geometry field, which contains the geometry of that specific segment of the route. We also have the directions for the segment, which could be used to communicate to the user.</p>

<p>The Geometry are presented in <a href="https://en.wikipedia.org/wiki/Well-known_text">WKT (Well-Known text)</a> format. To use in our map, we need to convert the WKT to a format the map can read. Mapbox (again) has created a helper library (<a href="https://github.com/mapbox/wellknown">wellknown</a>) to convert WKT to geoJSON, which we can then use or parse.</p>

<p>The ItinIsère data will require a little bit more work to display on the map: we need to convert each segment’s WKT to geoJSON, but that would leave us with a feature for each segment, whereas we want a single line. Using javascript’s <em>map</em> and <em>reduce</em> functions, we can convert the wkt with <em>map</em>, combine all the segments to one line with <em>reduce</em> and then swap [longitude,latitude] to [latitude.longitude] with another <em>map</em>.</p>

<p>First off, let’s include the wellknown library, by putting the reference under the polyline reference in index.html.</p>

<pre><code class="language-markdown">&lt;script src='https://rawgithub.com/mapbox/wellknown/master/wellknown.js'&gt;&lt;/script&gt;
</code></pre>

<p>In script.js (you can remove the call to getMetromobiliteRoute() if you’d like) we will put this at the end of the file:</p>

<pre><code class="language-javascript">function getItinisereRoute(fromPos, toPos, algorithm, callback) {
  clearRoutes();

  // get date elements to fill in date/time requirement of API
  var d = new Date();
  var dateString = d.toISOString().slice(0, 10);
  var timeString = d.getHours() + '-' + (d.getMinutes() &lt; 10 ? '0' : '') + d.getMinutes();

  // build uri for API
  var uri = 'http://www.itinisere.fr/webServices/TransinfoService/api/journeyplanner/v2/' +
            'BikeTrip/json?DepLat=' + fromPos[0] + '&amp;DepLon=' + fromPos[1] +
            '&amp;ArrLat=' + toPos[0] + '&amp;ArrLon=' + toPos[1] +
            '&amp;Date=' + dateString + '&amp;DepartureTime=' + timeString +
            '&amp;user_key=0016bf2ff47f630bab2e65bba954c091&amp;Algorithm=' + algorithm + '&amp;callback=?';

  $.getJSON(uri, function (data) {
    // get links for first trip
    var pathLinks = data.trips.Trip[0].sections.Section[0].Leg.pathLinks.PathLink;

    // isolate geometry from WKT string
    var linkCoords = pathLinks.map(function (link) {
      return wellknown.parse(link.Geometry).coordinates;
    });

    // combine all legs into one line
    var coords = linkCoords.reduce(function (a, b) {
      return a.concat(b);
    });

    // swap long/lat to lat/log
    var swappedCoords = coords.map(function (pair) {
      return pair.reverse();
    });

    // create polyline, assign color, bind popup, add to map
    bikeRouteII = L.polyline(swappedCoords, { color: '#044571' }).bindPopup('ItinIsère').addTo(map);

    callback();
  });
};

getItinisereRoute([45.1836656,5.703573], [45.195926,5.735935], 'FASTEST', function(){
  console.log('route completed');
})
</code></pre>

<p>And the results again:</p>

<!-- codepen embed -->
<p data-height="500" data-theme-id="0" data-slug-hash="EyVmEb" data-default-tab="result" data-user="abenrob" data-embed-version="2" data-preview="true" class="codepen"></p>
<!-- end codepen embed -->

<h1 id="app-build">App Build</h1>

<p>All those parts are great, but we need to pull them together now… We will need to create buttons and inputs to trigger each of the steps: get location, get address, get métromobilité route, get itinisère route.</p>

<p>We are going to use bootstrap to create a nice navbar, and put in buttons for each of the actions.</p>

<p>Let’s reference the bootstrap libraries (we are going to use a pre-styled build of bootstrap, provided by <a href="https://bootswatch.com/">bootswatch</a>).</p>

<p>Your &lt;head&gt; of index.html should look like this:</p>

<pre><code class="language-markdown">&lt;head&gt;
  &lt;meta charset=utf-8 /&gt;
  &lt;title&gt;VéloIsère&lt;/title&gt;
  &lt;meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' /&gt;
  &lt;link href='https://maxcdn.bootstrapcdn.com/bootswatch/3.3.6/superhero/bootstrap.min.css' rel='stylesheet' /&gt;
  &lt;link href='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.css' rel='stylesheet' /&gt;
  &lt;link href='style.css' rel='stylesheet' /&gt;
  &lt;script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.0/jquery.min.js'&gt;&lt;/script&gt;
  &lt;script src='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.6/js/bootstrap.min.js'&gt;&lt;/script&gt;
  &lt;script src='https://rawgithub.com/mapbox/polyline/master/src/polyline.js'&gt;&lt;/script&gt;
  &lt;script src='https://rawgithub.com/mapbox/wellknown/master/wellknown.js'&gt;&lt;/script&gt;
  &lt;script src='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.js'&gt;&lt;/script&gt;
&lt;/head&gt;
</code></pre>

<p>To add in the navbar and action buttons, replace your &lt;body&gt; block with this:</p>

<pre><code class="language-markdown">&lt;body&gt;
  &lt;div class="navbar navbar-default navbar-static-top"&gt;
    &lt;div class="container"&gt;
      &lt;div class="navbar-header"&gt;
        &lt;div class="navbar-brand"&gt;
          VéloIsère
        &lt;/div&gt;

        &lt;button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navHeaderCollapse"&gt;
          &lt;span class="icon-bar"&gt;&lt;/span&gt;
          &lt;span class="icon-bar"&gt;&lt;/span&gt;
          &lt;span class="icon-bar"&gt;&lt;/span&gt;
        &lt;/button&gt;
      &lt;/div&gt;
      &lt;div class="collapse navbar-collapse navHeaderCollapse"&gt;
        &lt;ul class="nav navbar-nav navbar-right"&gt;
          &lt;li&gt;&lt;button id="get_position" type="button" class="btn btn-primary"&gt;Get position&lt;/button&gt;&lt;/li&gt;
          &lt;li&gt;&lt;form class="navbar-form" role="search"&gt;
            &lt;div class="form-group"&gt;
              &lt;input id="address_search" type="text" class="form-control" placeholder="Search"&gt;
            &lt;/div&gt;
            &lt;button id="get_address" class="btn btn-success" onclick="return false;"&gt;Get address&lt;/button&gt;
          &lt;/form&gt;&lt;/li&gt;
          &lt;li class="dropdown"&gt;
            &lt;button id="route-menu" class="dropdown-toggle btn btn-info" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false" disabled&gt;Get route &lt;span class="caret"&gt;&lt;/span&gt;&lt;/button&gt;
            &lt;ul class="dropdown-menu"&gt;
              &lt;li&gt;&lt;button id="II-route" class="menu-btn btn btn-info"&gt;Itinisère&lt;/button&gt;&lt;/li&gt;
              &lt;li&gt;&lt;button id="MM-route" class="menu-btn btn btn-info"&gt;Métromobilité&lt;/button&gt;&lt;/li&gt;
            &lt;/ul&gt;
          &lt;/li&gt;
        &lt;/ul&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;

  &lt;div id="map"&gt;&lt;/div&gt;
  &lt;script src="script.js"&gt;&lt;/script&gt;
&lt;/body&gt;
</code></pre>

<p>and your style.css file should now look like this:</p>

<pre><code class="language-css">body {
  margin: 0;
  padding: 0;
}
.navbar {
  z-index: 2000;
}
.menu-btn {
  width: 100%;
}
#map {
  position: absolute;
  top: 41px;
  bottom: 0;
  width: 100%;
}
</code></pre>

<p>To trigger actions, we are going to use jQuery’s ‘click’ binding. We tell the application that on click of a certain element, do something.</p>

<pre><code class="language-javascript">$('#element_id').click(function () {
  // do somrthing now!
}
</code></pre>

<p>Add this to the bottom of your script.js file:</p>

<pre><code class="language-javascript">// function to close mobile nav menu
function closeNav() {
  $('.navHeaderCollapse').collapse('hide');
};

// jQuery click actions
// on get address click
$('#get_address').click(function () {
  // remove any routes
  clearRoutes();

  // get value of search box
  var search = $('#address_search').val();

  // call address function
  getBanAddressCoords(search, pos[0] || 45.186502, pos[1] || 5.736339, function () {
    $('#route-menu').prop('disabled', false);
  });
});

// on get location button click
$('#get_position').click(function () {
  // remove any routes
  clearRoutes();
  getUserLocation();
});

// on dropdown select, get the route
$('#MM-route').click(function () {
  getMetromobiliteRoute(pos, addressPos, function () {
    closeNav();
  });
});

// on dropdown select, get the route
$('#II-route').click(function () {
  getItinisereRoute(pos, addressPos, 'FASTEST', function () {
    closeNav();
  });
});
</code></pre>

<p>Now we have an app! (Try firefox to use the geolocation…)</p>

<!-- codepen embed -->
<p data-height="500" data-theme-id="0" data-slug-hash="rLOmQG" data-default-tab="result" data-user="abenrob" data-embed-version="2" data-preview="true" class="codepen"></p>
<!-- end codepen embed -->

<h2 id="fin-">Fin !</h2>

</div>
<script src="https://code.jquery.com/jquery-1.11.1.min.js" type="text/javascript"></script>
<script>
  $(document).ready(function(){
	  // sticky header with generated ids and anchors for <h1> tags
	  var title = $("#page-title");
	  title.after($("<div class='pull-left tutorial-navs'><ul id='tutorial-nav'></ul></div>"));

	  var heads = document.getElementsByTagName("h1");
	  var tutNav = document.getElementById("tutorial-nav");
	  for (var i=0; i<heads.length; i++) {
	    if(heads[i].className!="tutorial-title") {
	      var text = heads[i].innerHTML;
	      var target = nice(text);

	      // create list item and anchor
	      var item = document.createElement("li");
	      var anchor = document.createElement("a");
	      anchor.href = "#"+target;
	      anchor.innerHTML = text;
	      item.appendChild(anchor);
	      tutNav.appendChild(item);

	      // add id to h1 element in page
	      heads[i].id = target;
	    }
	  }

	  // collapse sections
	  $(".collapse-button").on("click", function(){
	    $(this).next(".collapse").slideToggle(200);
	  });

	  // click navigation anchors and animate scroll
	  $('a').on('click', function(event){
	    if($(this).attr('href').indexOf('#')>-1) {
	      event.preventDefault();
	      var id = $(this).attr("href");
	      var top = $(id).offset().top - 160;
	      $("html, body").animate({
	        scrollTop: top
	      }, 500); // you can set any time here
	    }
	  });

	  var nav = $("#tutorial-nav");
	  $("#tutorial-nav li:eq(0) a").addClass('nav-active');
	  var aChildren = $("#tutorial-nav li").children();
	  var aArray = [];
	  var top = nav.offset().top;

	  for (var i=0; i < aChildren.length; i++) {
	      var aChild = aChildren[i];
	      var ahref = $(aChild).attr('href');
	      aArray.push(ahref);
	  }

	});

	function nice(str) {
	  var newString = str.replace(/[^A-Z0-9]+/ig, "-").toLowerCase();
	  return newString;
	}
</script>


        

<div id="footerwrap">
    <div class="container">
        <div class="row">
            <div class="col-sm-6">
                <h4>About</h4>
                <div class="hline-w"></div>
                <p>We make maps in the Alps. On fait de la cartographie dans les Alpes!</p>
            </div>
            <div class="col-sm-6">
            



  


<h4>Social links</h4>
<div class="hline-w"></div>
<p>
    
        <a href="https://twitter.com/MaptimeAlpes" class="btn-social btn-outline"><i class="icon-twitter"></i></a>
    
        <a href="https://github.com/MaptimeAlpes" class="btn-social btn-outline"><i class="icon-github"></i></a>
    
        <a href="http://www.meetup.com/MaptimeAlpes/" class="btn-social btn-outline"><i class="icon-meetup"></i></a>
    
</p>
            </div>
        </div>
    </div>
</div>

    </body>
</html>
